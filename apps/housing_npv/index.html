<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¿äº§å†…åœ¨ä»·å€¼å»ºæ¨¡ (DCF + åœŸåœ°æ®‹å€¼)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #7c3aed; --bg: #f5f3ff; --card: #ffffff; --text: #1f2937; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
        
        /* å·¦ä¾§é¢æ¿ */
        .panel { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); height: fit-content; }
        h2 { margin-top: 0; color: var(--primary); font-size: 1.1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; margin-bottom: 15px; }
        
        .section-title { font-size: 0.85rem; font-weight: 800; color: #6d28d9; margin-top: 15px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em; }
        
        .input-group { margin-bottom: 10px; }
        label { display: block; font-size: 0.8rem; font-weight: 600; color: #4b5563; margin-bottom: 4px; }
        input { width: 100%; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; font-size: 0.95rem; }
        input:focus { outline: 2px solid var(--primary); border-color: transparent; }
        .hint { font-size: 0.7rem; color: #9ca3af; margin-top: 2px; }

        button { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; transition: 0.2s; }
        button:hover { background: #6d28d9; }

        /* å³ä¾§ç»“æœ */
        .results-area { display: flex; flex-direction: column; gap: 20px; }
        
        /* ä¼°å€¼å¤§å¡ç‰‡ */
        .valuation-card { background: linear-gradient(135deg, #7c3aed 0%, #4c1d95 100%); color: white; padding: 25px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 15px -3px rgba(124, 58, 237, 0.3); }
        .val-left h3 { margin: 0; font-weight: 400; opacity: 0.9; font-size: 0.9rem; }
        .val-number { font-size: 2.2rem; font-weight: 800; margin: 5px 0 0 0; }
        .val-right { text-align: right; }
        .val-sub { font-size: 0.9rem; opacity: 0.8; }
        .val-sub strong { font-size: 1.1rem; opacity: 1; }

        .breakdown-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .mini-card { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; }
        .mini-val { font-size: 1.2rem; font-weight: 700; color: var(--text); }
        .mini-lbl { font-size: 0.8rem; color: #6b7280; }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-box { background: white; padding: 20px; border-radius: 12px; height: 350px; border: 1px solid #e5e7eb; }

        /* è¯¦æƒ…è¡¨ */
        .table-box { background: white; border-radius: 12px; overflow: hidden; border: 1px solid #e5e7eb; max-height: 400px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: #f3f4f6; position: sticky; top: 0; padding: 10px; text-align: right; color: #374151; z-index: 10; font-weight: 600; }
        td { padding: 8px 10px; text-align: right; border-bottom: 1px solid #f9fafb; }
        th:first-child, td:first-child { text-align: left; padding-left: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="panel">
        <h2>ğŸ—ï¸ ä¼°å€¼å‚æ•°å»ºæ¨¡</h2>
        
        <div class="section-title">åŸºç¡€å‡è®¾</div>
        <div class="input-group">
            <label>å½“å‰å¸‚åœºæŒ‚ç‰Œä»· (ç”¨äºæ‹†åˆ†åŸºæ•°)</label>
            <input type="number" id="marketPrice" value="10000000">
        </div>
        <div class="input-group">
            <label>åœŸåœ°ä»·å€¼å æ¯” (%)</label>
            <input type="number" id="landRatio" value="60">
            <div class="hint">ä¸€äºŒçº¿åŸå¸‚åœŸåœ°é€šå¸¸å 60%-80%</div>
        </div>
        <div class="input-group">
            <label>æŒæœ‰/æ¨¡æ‹Ÿå¹´é™ (å¹´)</label>
            <input type="number" id="years" value="30">
        </div>
        <div class="input-group">
            <label>æŠ˜ç°ç‡/ä½ çš„è¦æ±‚å›æŠ¥ç‡ (%)</label>
            <input type="number" id="discountRate" value="6.0" step="0.1">
            <div class="hint">é£é™©è¶Šé«˜ï¼Œæ­¤å€¼åº”è¶Šé«˜</div>
        </div>

        <div class="section-title">ç°é‡‘æµè¾“å…¥ (å¹´åŒ–)</div>
        <div class="input-group">
            <label>å½“å‰å¹´ç§Ÿé‡‘</label>
            <input type="number" id="rent" value="200000">
        </div>
        <div class="input-group">
            <label>ç§Ÿé‡‘å¹´å¢é•¿ç‡ (%)</label>
            <input type="number" id="rentGrowth" value="2.0" step="0.1">
        </div>
        
        <div class="section-title">æ”¯å‡ºä¸ç»´æŠ¤</div>
        <div class="input-group">
            <label>å¹´ç»´æŠ¤/æŠ˜æ—§/ç‰©ä¸šæ”¯å‡º</label>
            <input type="number" id="maintenance" value="30000">
        </div>
        <div class="input-group">
            <label>å¹´æˆ¿äº§ç¨</label>
            <input type="number" id="tax" value="5000">
        </div>
        <div class="input-group">
            <label>æ”¯å‡ºé€šèƒ€ç‡ (%)</label>
            <input type="number" id="expenseInflation" value="3.0" step="0.1">
        </div>

        <div class="section-title">æœŸæœ«ç»ˆå€¼å‡è®¾</div>
        <div class="input-group">
            <label>åœŸåœ°å¹´å‡å‡å€¼ç‡ (%)</label>
            <input type="number" id="landGrowth" value="3.0" step="0.1">
        </div>
        <div class="input-group">
            <label>å»ºç­‘ç‰©ç†å¹´æŠ˜æ—§ç‡ (%)</label>
            <input type="number" id="bldgDepreciation" value="2.0" step="0.1">
            <div class="hint">å»ºç­‘è€åŒ–å¯¼è‡´çš„ä»·å€¼æŸè€—</div>
        </div>

        <button onclick="calculate()">ğŸ”® è®¡ç®—å†…åœ¨ä»·å€¼</button>
    </div>

    <div class="results-area">
        
        <div class="valuation-card">
            <div class="val-left">
                <h3>æ¨¡å‹è®¡ç®—å†…åœ¨ä»·å€¼ (NPV)</h3>
                <div class="val-number" id="intrinsicValue">--</div>
            </div>
            <div class="val-right">
                <div class="val-sub">å¯¹æ¯”å¸‚åœºä»·æº¢ä»·ç‡: <span id="premium">--</span></div>
                <div class="val-sub" style="margin-top:5px;">å»ºè®®: <span id="advice" style="font-weight:bold">--</span></div>
            </div>
        </div>

        <div class="breakdown-grid">
            <div class="mini-card">
                <div class="mini-val" id="pvCashflow" style="color:#7c3aed">--</div>
                <div class="mini-lbl">ç§Ÿé‡‘æ”¶ç›Šç°å€¼</div>
            </div>
            <div class="mini-card">
                <div class="mini-val" id="pvLand" style="color:#059669">--</div>
                <div class="mini-lbl">åœŸåœ°ç»ˆå€¼ç°å€¼</div>
            </div>
            <div class="mini-card">
                <div class="mini-val" id="pvBldg" style="color:#d97706">--</div>
                <div class="mini-lbl">å»ºç­‘æ®‹å€¼ç°å€¼</div>
            </div>
        </div>

        <div class="chart-box">
            <canvas id="cfChart"></canvas>
        </div>

        <div class="table-box">
            <table id="detailsTable">
                <thead>
                    <tr>
                        <th>å¹´ä»½</th>
                        <th>å‡€ç°é‡‘æµ(NOI)</th>
                        <th>åœŸåœ°ä»·å€¼</th>
                        <th>å»ºç­‘ä»·å€¼</th>
                        <th>æ€»ä»·å€¼å¿«ç…§</th>
                        <th>NOIæŠ˜ç°å› å­</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let myChart = null;

    function fmt(num) {
        return num.toLocaleString('zh-CN', { maximumFractionDigits: 0 });
    }

    function calculate() {
        // --- 1. è·å–è¾“å…¥ ---
        const marketPrice = parseFloat(document.getElementById('marketPrice').value);
        const landRatio = parseFloat(document.getElementById('landRatio').value) / 100;
        const years = parseInt(document.getElementById('years').value);
        const discountRate = parseFloat(document.getElementById('discountRate').value) / 100;

        const rentStart = parseFloat(document.getElementById('rent').value);
        const rentGrowth = parseFloat(document.getElementById('rentGrowth').value) / 100;
        
        const maintStart = parseFloat(document.getElementById('maintenance').value);
        const taxStart = parseFloat(document.getElementById('tax').value);
        const expInflation = parseFloat(document.getElementById('expenseInflation').value) / 100;

        const landGrowth = parseFloat(document.getElementById('landGrowth').value) / 100;
        const bldgDepr = parseFloat(document.getElementById('bldgDepreciation').value) / 100;

        // --- 2. åˆå§‹æ‹†åˆ† ---
        let initialLandVal = marketPrice * landRatio;
        let initialBldgVal = marketPrice * (1 - landRatio);

        // --- 3. é€å¹´è®¡ç®— ---
        let totalPVCashFlow = 0;
        let currentRent = rentStart;
        let currentMaint = maintStart;
        let currentTax = taxStart;
        
        let chartLabels = [];
        let chartNOI = [];
        let chartAssetVal = [];

        let tableHtml = '';

        for (let t = 1; t <= years; t++) {
            // A. ç°é‡‘æµéƒ¨åˆ†
            let expense = currentMaint + currentTax;
            let noi = currentRent - expense;
            
            // æŠ˜ç°
            let df = 1 / Math.pow(1 + discountRate, t);
            let pv_noi = noi * df;
            totalPVCashFlow += pv_noi;

            // B. èµ„äº§ä»·å€¼å¿«ç…§ (ç”¨äºå±•ç¤ºï¼Œä¸åšæŠ˜ç°å åŠ ï¼Œä»…è®¡ç®—æœ€åä¸€å¹´)
            let landValT = initialLandVal * Math.pow(1 + landGrowth, t);
            let bldgValT = initialBldgVal * Math.pow(1 - bldgDepr, t);
            let totalAssetVal = landValT + bldgValT;

            // è®°å½•æ•°æ®
            chartLabels.push(t);
            chartNOI.push(noi);
            chartAssetVal.push(totalAssetVal);

            tableHtml += `<tr>
                <td>ç¬¬ ${t} å¹´</td>
                <td style="font-weight:bold">${fmt(noi)}</td>
                <td style="color:#059669">${fmt(landValT)}</td>
                <td style="color:#d97706">${fmt(bldgValT)}</td>
                <td>${fmt(totalAssetVal)}</td>
                <td style="color:#9ca3af">${df.toFixed(4)}</td>
            </tr>`;

            // æ›´æ–°ä¸‹ä¸€å¹´çš„åŸºç¡€æ•°æ®
            currentRent *= (1 + rentGrowth);
            currentMaint *= (1 + expInflation);
            currentTax *= (1 + expInflation); // å‡è®¾ç¨æ”¶ä¹Ÿéšé€šèƒ€è°ƒæ•´ï¼Œä¹Ÿå¯ä»¥è®¾ä¸ºå›ºå®š
        }

        // --- 4. è®¡ç®—æœŸæœ«ç»ˆå€¼ (Terminal Value) åŠå…¶ç°å€¼ ---
        // é€»è¾‘ï¼šåœ¨ç¬¬Nå¹´å–å‡ºï¼Œå¾—åˆ°çš„é’±æ˜¯å½“æ—¶çš„ åœŸåœ°å€¼ + å»ºç­‘å€¼
        let finalLandVal = initialLandVal * Math.pow(1 + landGrowth, years);
        let finalBldgVal = initialBldgVal * Math.pow(1 - bldgDepr, years);
        
        let pv_FinalLand = finalLandVal / Math.pow(1 + discountRate, years);
        let pv_FinalBldg = finalBldgVal / Math.pow(1 + discountRate, years);

        let intrinsicValue = totalPVCashFlow + pv_FinalLand + pv_FinalBldg;

        // --- 5. æ›´æ–° UI ---
        
        // æ ¸å¿ƒæ•°å€¼
        document.getElementById('intrinsicValue').innerText = fmt(intrinsicValue);
        document.getElementById('pvCashflow').innerText = fmt(totalPVCashFlow);
        document.getElementById('pvLand').innerText = fmt(pv_FinalLand);
        document.getElementById('pvBldg').innerText = fmt(pv_FinalBldg);

        // è¡¨æ ¼
        document.querySelector('#detailsTable tbody').innerHTML = tableHtml;

        // è¯„ä»·é€»è¾‘
        let diff = (intrinsicValue - marketPrice) / marketPrice;
        let adviceEl = document.getElementById('advice');
        let premiumEl = document.getElementById('premium');
        
        premiumEl.innerText = (diff * 100).toFixed(1) + "%";
        
        if (diff > 0.1) {
            adviceEl.innerText = "ä½ä¼° (å€¼å¾—ä¹°å…¥)";
            adviceEl.style.color = "#059669";
        } else if (diff < -0.1) {
            adviceEl.innerText = "é«˜ä¼° (ä»·æ ¼è™šé«˜)";
            adviceEl.style.color = "#dc2626";
        } else {
            adviceEl.innerText = "ä»·æ ¼åˆç†";
            adviceEl.style.color = "#d97706";
        }

        // --- 6. ç»˜å›¾ (Chart.js) ---
        renderChart(chartLabels, chartNOI, chartAssetVal);
    }

    function renderChart(labels, noiData, assetData) {
        const ctx = document.getElementById('cfChart').getContext('2d');
        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'é¢„ä¼°æˆ¿äº§æ€»å€¼ (å³è½´)',
                        data: assetData,
                        borderColor: '#7c3aed',
                        backgroundColor: 'rgba(124, 58, 237, 0.1)',
                        yAxisID: 'y_asset',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'å½“å¹´å‡€ç°é‡‘æµ NOI (å·¦è½´)',
                        data: noiData,
                        borderColor: '#059669',
                        backgroundColor: '#059669',
                        type: 'bar',
                        yAxisID: 'y_flow'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y_flow: { 
                        type: 'linear', display: true, position: 'left', 
                        title: {display:true, text:'å¹´åº¦å‡€æ”¶å…¥ (NOI)'},
                        grid: { display: false }
                    },
                    y_asset: { 
                        type: 'linear', display: true, position: 'right', 
                        title: {display:true, text:'èµ„äº§åä¹‰ä»·å€¼ (åœŸåœ°+å»ºç­‘)'} 
                    }
                }
            }
        });
    }

    window.onload = calculate;
</script>

</body>
</html>