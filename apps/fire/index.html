<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIRE çœŸå®æ³¢åŠ¨æ¨¡æ‹Ÿå™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --p: #3b82f6; --bg: #f3f4f6; --card: #fff; --text: #1f2937; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        .app-container { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        
        /* å·¦ä¾§æ§åˆ¶æ  */
        .controls { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); height: fit-content; }
        h2 { margin-top: 0; color: var(--p); font-size: 1.2rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; color: #4b5563; margin-bottom: 5px; }
        input { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        .hint { font-size: 0.75rem; color: #9ca3af; margin-top: 2px; }
        button { width: 100%; background: var(--p); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        button:hover { background: #2563eb; }

        /* å³ä¾§æ˜¾ç¤ºåŒº */
        .display-area { display: flex; flex-direction: column; gap: 20px; }
        
        /* æ¦‚è§ˆå¡ç‰‡ */
        .summary-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .card { background: var(--card); padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card-val { font-size: 1.4rem; font-weight: 800; color: var(--p); }
        .card-lbl { font-size: 0.85rem; color: #6b7280; }
        .success { color: #10b981; } .fail { color: #ef4444; }

        /* å›¾è¡¨åŒº */
        .chart-box { background: var(--card); padding: 15px; border-radius: 12px; height: 400px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        /* è¡¨æ ¼åŒº */
        .table-box { background: var(--card); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #f9fafb; text-align: right; padding: 10px; font-weight: 600; color: #374151; position: sticky; top: 0; }
        td { padding: 8px 10px; text-align: right; border-bottom: 1px solid #f3f4f6; }
        th:first-child, td:first-child { text-align: center; }
        tr:last-child td { border-bottom: none; }
        .pos { color: #10b981; } .neg { color: #ef4444; }

        @media (max-width: 768px) { .app-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="app-container">
    <div class="controls">
        <h2>ğŸ“Š å‚æ•°è®¾ç½®</h2>
        
        <div class="input-group">
            <label>åˆå§‹èµ„é‡‘ (å…ƒ)</label>
            <input type="number" id="capital" value="3000000">
        </div>
        <div class="input-group">
            <label>æ¯å¹´ç¨³å®šæ”¶å…¥ (å…ƒ)</label>
            <input type="number" id="income" value="0">
        </div>
        <div class="input-group">
            <label>åˆå§‹å¹´æ¶ˆè´¹ (å…ƒ)</label>
            <input type="number" id="expense" value="120000">
        </div>
        <div class="input-group">
            <label>é€šè´§è†¨èƒ€ç‡ (%)</label>
            <input type="number" id="cpi" value="3" step="0.1">
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin: 15px 0;">
        
        <div class="input-group">
            <label>æ¨¡æ‹Ÿæ€»å¹´æ•°</label>
            <input type="number" id="years" value="40">
        </div>
        <div class="input-group">
            <label>10å¹´å¹³å‡å¹´åŒ– (%)</label>
            <input type="number" id="avgRate" value="10" step="0.1">
            <div class="hint">æ¯10å¹´çš„å¹³å‡æ”¶ç›Šé”å®šä¸ºæ­¤å€¼</div>
        </div>
        <div class="input-group">
            <label>å•å¹´æ³¢åŠ¨èŒƒå›´ (%)</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="minRate" value="-30" placeholder="æœ€ä½">
                <input type="number" id="maxRate" value="50" placeholder="æœ€é«˜">
            </div>
            <div class="hint">æ”¶ç›Šç‡å°†åœ¨æœ€ä½å’Œæœ€é«˜ä¹‹é—´éšæœºæ³¢åŠ¨</div>
        </div>

        <button onclick="simulate()">ğŸ”„ å¼€å§‹æ¨¡æ‹Ÿ</button>
    </div>

    <div class="display-area">
        <div class="summary-cards">
            <div class="card">
                <div class="card-val" id="res-status">--</div>
                <div class="card-lbl">æœ€ç»ˆçŠ¶æ€</div>
            </div>
            <div class="card">
                <div class="card-val" id="res-asset">--</div>
                <div class="card-lbl">æœŸæœ«/ç ´äº§æ—¶èµ„äº§</div>
            </div>
            <div class="card">
                <div class="card-val" id="res-years">--</div>
                <div class="card-lbl">èµ„é‡‘ç»´æŒå¹´æ•°</div>
            </div>
        </div>

        <div class="chart-box">
            <canvas id="mainChart"></canvas>
        </div>

        <div class="table-box">
            <div style="max-height: 400px; overflow-y: auto;">
                <table id="detailsTable">
                    <thead>
                        <tr>
                            <th>å¹´ä»½</th>
                            <th>æ”¶ç›Šç‡</th>
                            <th>å¹´åˆèµ„äº§</th>
                            <th>- æ”¯å‡º</th>
                            <th>+ æ”¶å…¥</th>
                            <th>+/- æŠ•èµ„ç›ˆäº</th>
                            <th>= å¹´æœ«èµ„äº§</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let chartInstance = null;

    // æ ¸å¿ƒç®—æ³•ï¼šç”Ÿæˆä¸€æ®µå¹³å‡å€¼ä¸º target çš„éšæœºæ³¢åŠ¨æ•°ç»„
    function getVolatileBlock(count, targetAvg, min, max) {
        let rates = [];
        // 1. åˆå§‹éšæœº
        for(let i=0; i<count; i++) rates.push(Math.random() * (max - min) + min);
        
        // 2. è¿­ä»£ä¿®æ­£ä»¥åŒ¹é…å‡å€¼
        for(let iter=0; iter<20; iter++) {
            let currentAvg = rates.reduce((a,b)=>a+b, 0) / count;
            let diff = targetAvg - currentAvg;
            if(Math.abs(diff) < 0.0001) break;
            
            rates = rates.map(r => {
                let newVal = r + diff;
                return Math.max(min, Math.min(max, newVal)); // é’³ä½
            });
        }
        
        // 3. æ´—ç‰Œ (è®©å¤§æ¶¨å¤§è·Œéšæœºåˆ†å¸ƒ)
        for (let i = rates.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [rates[i], rates[j]] = [rates[j], rates[i]];
        }
        return rates;
    }

    function simulate() {
        // è·å–è¾“å…¥
        const cap0 = +document.getElementById('capital').value;
        const inc = +document.getElementById('income').value;
        const exp0 = +document.getElementById('expense').value;
        const cpi = +document.getElementById('cpi').value / 100;
        const years = +document.getElementById('years').value;
        const avgR = +document.getElementById('avgRate').value / 100;
        const minR = +document.getElementById('minRate').value / 100;
        const maxR = +document.getElementById('maxRate').value / 100;

        // ç”Ÿæˆæ”¶ç›Šç‡åºåˆ—
        let rates = [];
        const blocks = Math.ceil(years / 10);
        for(let i=0; i<blocks; i++) {
            let count = (i === blocks-1) ? (years - i*10) : 10;
            if(count > 0) rates = rates.concat(getVolatileBlock(count, avgR, minR, maxR));
        }

        // æ¨¡æ‹Ÿè®¡ç®—
        let data = [];
        let curCap = cap0;
        let curExp = exp0;
        let brokenYear = null;

        let tableHtml = '';

        for(let i=0; i<years; i++) {
            let r = rates[i];
            let startCap = curCap;
            
            // æ¶ˆè´¹é€šèƒ€ï¼ˆç¬¬1å¹´ä¸é€šèƒ€ï¼‰
            if(i > 0) curExp *= (1 + cpi);

            // æ ¸å¿ƒå…¬å¼ï¼šå…ˆç®—æŠ•èµ„ç›ˆäºï¼Œå†æ”¶æ”¯
            let profit = startCap * r;
            let endCap = startCap + profit + inc - curExp;

            // è®°å½•æ•°æ®
            data.push({
                year: i+1,
                rate: r,
                assets: endCap
            });

            // è¡¨æ ¼è¡Œ
            let rClass = r >= 0 ? 'pos' : 'neg';
            let capClass = endCap >= 0 ? '' : 'neg';
            tableHtml += `<tr>
                <td>${i+1}</td>
                <td class="${rClass}">${(r*100).toFixed(2)}%</td>
                <td>${Math.round(startCap).toLocaleString()}</td>
                <td>${Math.round(curExp).toLocaleString()}</td>
                <td>${Math.round(inc).toLocaleString()}</td>
                <td class="${rClass}">${Math.round(profit).toLocaleString()}</td>
                <td class="${capClass}" style="font-weight:bold">${Math.round(endCap).toLocaleString()}</td>
            </tr>`;

            curCap = endCap;
            if(curCap < 0 && brokenYear === null) brokenYear = i+1;
        }

        // æ›´æ–° UI
        document.querySelector('#detailsTable tbody').innerHTML = tableHtml;

        // æ¦‚è§ˆå¡ç‰‡
        const statusEl = document.getElementById('res-status');
        if (brokenYear) {
            statusEl.innerText = "ç ´äº§";
            statusEl.className = "card-val fail";
            document.getElementById('res-years').innerText = brokenYear + " å¹´";
        } else {
            statusEl.innerText = "æˆåŠŸ";
            statusEl.className = "card-val success";
            document.getElementById('res-years').innerText = "> " + years + " å¹´";
        }
        document.getElementById('res-asset').innerText = Math.round(curCap).toLocaleString();

        // ç»˜å›¾
        drawChart(data);
    }

    function drawChart(data) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d.year),
                datasets: [
                    {
                        type: 'line',
                        label: 'èµ„äº§æ›²çº¿',
                        data: data.map(d => d.assets),
                        borderColor: '#3b82f6',
                        borderWidth: 2,
                        yAxisID: 'y',
                        tension: 0.3,
                        pointRadius: 1
                    },
                    {
                        type: 'bar',
                        label: 'å½“å¹´æ¶¨è·Œå¹…%',
                        data: data.map(d => d.rate * 100),
                        backgroundColor: data.map(d => d.rate >= 0 ? 'rgba(16, 185, 129, 0.5)' : 'rgba(239, 68, 68, 0.5)'),
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { position: 'left', title: {display:true, text:'èµ„äº§ (å…ƒ)'} },
                    y1: { position: 'right', grid: {drawOnChartArea:false}, title: {display:true, text:'æ”¶ç›Šç‡ (%)'} }
                }
            }
        });
    }

    // è‡ªåŠ¨è¿è¡Œä¸€æ¬¡
    window.onload = simulate;
</script>
</body>
</html>